name: Test Validation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  validate-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Build project
      run: mvn clean compile

    - name: Run all tests
      run: mvn test
      continue-on-error: true

    - name: Generate test report
      if: always()
      run: mvn surefire-report:report

    - name: Check test results
      run: |
        echo "=== Test Results Summary ==="

        if [ ! -d "target/surefire-reports" ]; then
          echo "No test reports directory found"
          exit 1
        fi

        TEST_FILES=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null | wc -l)
        if [ "$TEST_FILES" -eq 0 ]; then
          echo "No test reports found"
          exit 1
        fi

        echo "Test reports found ($TEST_FILES files)"

        TOTAL_TESTS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -o 'tests="[0-9]*"' {} \; | sed 's/tests="//;s/"//' | awk '{s+=$1} END {print s}')
        FAILED_TESTS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -o 'failures="[0-9]*"' {} \; | sed 's/failures="//;s/"//' | awk '{s+=$1} END {print s}')
        SKIPPED_TESTS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -o 'skipped="[0-9]*"' {} \; | sed 's/skipped="//;s/"//' | awk '{s+=$1} END {print s}')
        ERROR_TESTS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -o 'errors="[0-9]*"' {} \; | sed 's/errors="//;s/"//' | awk '{s+=$1} END {print s}')

        TOTAL_TESTS=${TOTAL_TESTS:-0}
        FAILED_TESTS=${FAILED_TESTS:-0}
        SKIPPED_TESTS=${SKIPPED_TESTS:-0}
        ERROR_TESTS=${ERROR_TESTS:-0}

        PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS - SKIPPED_TESTS - ERROR_TESTS))

        echo "════════════════════════════════"
        echo "Total tests: $TOTAL_TESTS"
        echo "Passed: $PASSED_TESTS"
        echo "Failed: $FAILED_TESTS"
        echo "Errors: $ERROR_TESTS"
        echo "Skipped: $SKIPPED_TESTS"
        echo "════════════════════════════════"

        MIN_TESTS=10
        if [ "$TOTAL_TESTS" -lt "$MIN_TESTS" ]; then
          echo "Warning: Expected at least $MIN_TESTS tests, but found only $TOTAL_TESTS"
        fi

        IMPLEMENTED_TESTS=$((TOTAL_TESTS - SKIPPED_TESTS))
        if [ "$IMPLEMENTED_TESTS" -eq 0 ]; then
          echo "No tests implemented (all tests are @Disabled)"
          exit 1
        fi

        echo "Implemented tests: $IMPLEMENTED_TESTS"

        if [ "$FAILED_TESTS" -gt 0 ] || [ "$ERROR_TESTS" -gt 0 ]; then
          echo "Some tests are failing or have errors"
          exit 1
        fi

        echo "All implemented tests passed successfully!"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/site/
        retention-days: 30

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          let comment = '##  Test Results\n\n';

          try {
            const reportsDir = 'target/surefire-reports';
            const files = fs.readdirSync(reportsDir).filter(f => f.startsWith('TEST-') && f.endsWith('.xml'));

            let totalTests = 0;
            let failedTests = 0;
            let skippedTests = 0;
            let errorTests = 0;

            files.forEach(file => {
              const content = fs.readFileSync(path.join(reportsDir, file), 'utf8');
              const testsMatch = content.match(/tests="(\d+)"/);
              const failuresMatch = content.match(/failures="(\d+)"/);
              const skippedMatch = content.match(/skipped="(\d+)"/);
              const errorsMatch = content.match(/errors="(\d+)"/);

              if (testsMatch) totalTests += parseInt(testsMatch[1]);
              if (failuresMatch) failedTests += parseInt(failuresMatch[1]);
              if (skippedMatch) skippedTests += parseInt(skippedMatch[1]);
              if (errorsMatch) errorTests += parseInt(errorsMatch[1]);
            });

            const passedTests = totalTests - failedTests - skippedTests - errorTests;
            const implementedTests = totalTests - skippedTests;

            comment += `| Metric | Count |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Total Tests | ${totalTests} |\n`;
            comment += `| Passed | ${passedTests} |\n`;
            comment += `| Failed | ${failedTests} |\n`;
            comment += `| Errors | ${errorTests} |\n`;
            comment += `| Skipped | ${skippedTests} |\n`;
            comment += `| Implemented | ${implementedTests} |\n\n`;

            if (implementedTests === 0) {
              comment += ' **No tests implemented yet.** All tests are marked with `@Disabled`.\n';
            } else if (failedTests > 0 || errorTests > 0) {
              comment += '**Some tests are failing.** Please fix the failing tests.\n';
            } else {
              comment += '**All implemented tests passed!** Great job!\n';
            }

          } catch (error) {
            comment += ' Could not read test results.\n';
            comment += `Error: ${error.message}\n`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
